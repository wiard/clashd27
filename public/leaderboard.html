<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CLASHD27 ‚Äî Gap Leaderboard</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121821;
      --text: #e6edf3;
      --muted: #9aa7b2;
      --accent: #ff6b35;
      --border: #1f2833;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Space Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      background: radial-gradient(circle at 20% 20%, rgba(255,107,53,0.08), transparent 40%), var(--bg);
      color: var(--text);
    }
    header {
      padding: 24px 32px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    h1 { margin: 0; font-size: 20px; letter-spacing: 1px; }
    .sub { color: var(--muted); font-size: 12px; }
    .container { padding: 24px 32px 48px; }
    .table {
      width: 100%;
      border-collapse: collapse;
      background: var(--panel);
      border: 1px solid var(--border);
    }
    .table th, .table td {
      text-align: left;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }
    .table th { color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; font-size: 10px; }
    .row { cursor: pointer; }
    .row:hover { background: rgba(255,255,255,0.03); }
    .repo { color: var(--accent); font-weight: 600; }
    .details {
      margin-top: 16px;
      padding: 16px;
      background: var(--panel);
      border: 1px solid var(--border);
      display: none;
    }
    .details h3 { margin: 0 0 8px 0; font-size: 14px; }
    .gap-list { list-style: none; padding: 0; margin: 0; }
    .gap-item { padding: 8px 0; border-bottom: 1px solid var(--border); }
    .gap-item:last-child { border-bottom: none; }
    .badge { display: inline-block; padding: 2px 6px; font-size: 10px; border: 1px solid var(--border); color: var(--muted); margin-left: 6px; }
    .status-open { color: #f4d35e; }
    .status-responded { color: #7bdff2; }
    .status-resolved { color: #7ee081; }
    .status-posted { color: #c792ea; }
    .loading { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üèÜ Gap Leaderboard</h1>
      <div class="sub">Derived from gaps-index.json ¬∑ updated live</div>
    </div>
    <div class="sub" id="updated">Loading‚Ä¶</div>
  </header>
  <div class="container">
    <table class="table" id="leaderboard-table">
      <thead>
        <tr>
          <th>Repo</th>
          <th>Resolved</th>
          <th>Responded</th>
          <th>Open</th>
          <th>Total</th>
          <th>Maintainer</th>
          <th>Last Gap</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body">
        <tr><td class="loading" colspan="7">Loading leaderboard‚Ä¶</td></tr>
      </tbody>
    </table>

    <div class="details" id="details">
      <h3 id="details-title">Repo details</h3>
      <ul class="gap-list" id="gap-list"></ul>
    </div>
  </div>

<script>
async function fetchLeaderboard() {
  const res = await fetch('/api/leaderboard');
  return res.json();
}

async function fetchRepoDetails(repo) {
  const res = await fetch(`/api/leaderboard/${encodeURIComponent(repo)}`);
  return res.json();
}

function renderLeaderboard(rows) {
  const body = document.getElementById('leaderboard-body');
  if (!rows || !rows.length) {
    body.innerHTML = '<tr><td class="loading" colspan="7">No data yet.</td></tr>';
    return;
  }
  body.innerHTML = rows.map(r => `
    <tr class="row" data-repo="${r.repo}">
      <td class="repo">${r.repo}</td>
      <td>${r.resolved}</td>
      <td>${r.responded}</td>
      <td>${r.open}</td>
      <td>${r.gaps_found}</td>
      <td>${r.maintainer_x_handle || '‚Äî'}</td>
      <td>${r.last_gap_date || '‚Äî'}</td>
    </tr>
  `).join('');

  document.querySelectorAll('.row').forEach(row => {
    row.addEventListener('click', async () => {
      const repo = row.getAttribute('data-repo');
      const details = await fetchRepoDetails(repo);
      renderDetails(details);
    });
  });
}

function renderDetails(details) {
  const panel = document.getElementById('details');
  const title = document.getElementById('details-title');
  const list = document.getElementById('gap-list');
  const gaps = details.gaps || [];

  title.textContent = `Repo: ${details.repo} (${gaps.length} gaps)`;
  if (!gaps.length) {
    list.innerHTML = '<li class="gap-item loading">No gaps recorded.</li>';
  } else {
    list.innerHTML = gaps.map(g => `
      <li class="gap-item">
        <div><strong>${g.id}</strong> <span class="badge status-${g.status}">${g.status}</span></div>
        <div>${g.claim || ''}</div>
        <div class="sub">${g.createdAt || '‚Äî'}</div>
      </li>
    `).join('');
  }
  panel.style.display = 'block';
}

(async function init() {
  try {
    const data = await fetchLeaderboard();
    renderLeaderboard(data);
    document.getElementById('updated').textContent = `Updated ${new Date().toLocaleTimeString()}`;
  } catch (e) {
    document.getElementById('leaderboard-body').innerHTML = '<tr><td class="loading" colspan="7">Failed to load.</td></tr>';
  }
})();
</script>
</body>
</html>
